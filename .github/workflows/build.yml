name: Build and Sign Release APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Create app directory
        run: mkdir -p app

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > app/keystore.jks
          # ØªØ¹ÙŠÙŠÙ† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¢Ù…Ù†Ø© Ù„Ù„Ù…Ù„Ù
          chmod 600 app/keystore.jks

      - name: Verify Keystore and List Aliases
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "ðŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù keystore..."
          if [ -f "app/keystore.jks" ]; then
            echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù keystore"
            echo "ðŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ Aliases Ø§Ù„Ù…ØªØ§Ø­Ø©:"
            keytool -list -keystore app/keystore.jks -storepass "$STORE_PASSWORD" -v | grep "Alias name:" || echo "âŒ ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ aliases"
            
            echo "ðŸ”Ž Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù€ alias Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: $KEY_ALIAS"
            if keytool -list -keystore app/keystore.jks -storepass "$STORE_PASSWORD" -alias "$KEY_ALIAS" >/dev/null 2>&1; then
              echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù€ alias: $KEY_ALIAS"
            else
              echo "âŒ Ø§Ù„Ù€ alias '$KEY_ALIAS' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ keystore!"
              echo "ðŸ“ Ø§Ù„Ù€ Aliases Ø§Ù„Ù…ØªÙˆÙØ±Ø©:"
              keytool -list -keystore app/keystore.jks -storepass "$STORE_PASSWORD"
              exit 1
            fi
          else
            echo "âŒ Ù…Ù„Ù keystore.jks ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi

      - name: Build Release APK
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --info

      - name: Find and Upload APK
        run: |
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù APK Ø¨Ø£ÙŠ Ø§Ø³Ù… (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡)
          APK_FILE=$(find . -name "*.apk" -path "*/release/*" | head -1)
          if [ -f "$APK_FILE" ]; then
            echo "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù APK: $APK_FILE"
            echo "APK_PATH=$APK_FILE" >> $GITHUB_ENV
          else
            echo "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„Ù APK!"
            find . -name "*.apk" || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª APK"
            exit 1
          fi

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: Al-Shamri-Currency-Converter-Release
          path: ${{ env.APK_PATH }}

      - name: Show Build Info
        if: always()
        run: |
          echo "ðŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:"
          echo "-----------------"
          echo "Ø§Ù„Ù€ Alias Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${{ secrets.KEY_ALIAS }}"
          echo "Ø­Ø¬Ù… Ù…Ù„Ù keystore: $(du -h app/keystore.jks 2>/dev/null || echo 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯')"
          echo "Ø§Ù„Ù€ APK Ø§Ù„Ù†Ø§ØªØ¬: ${{ env.APK_PATH }}"
